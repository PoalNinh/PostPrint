<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phi·∫øu Giao H√†ng - M·ªôc ·∫§n</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Times New Roman', Times, serif;
            background-color: white;
            padding: 15px;
            font-size: 13px;
        }

        .container {
            max-width: 210mm;
            margin: 0 auto;
            background: white;
        }

        /* Print Controls */
        .print-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #ddd;
        }

        .print-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.3s;
        }

        .print-btn:hover {
            background: #c0392b;
        }

        .print-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .logo {
            width: 100%;
        }

        .logo img {
            width: 100%;
        }

        .contact-info {
            text-align: right;
            font-size: 14px;
            margin-top: 20px;
        }

        /* Title */
        .title {
            text-align: center;
            font-size: 23px;
            font-weight: bold;
            margin-bottom: 2px;
            letter-spacing: 2px;
        }

        .order-number {
            text-align: center;
            font-size: 15px;
            margin-bottom: 15px;
            font-style: italic;
        }

        /* Customer Info Table */
        .customer-info {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #000;
            margin-bottom: 3px;
        }

        .customer-info td {
            border: 1px solid #000;
            padding: 6px;
            font-size: 15px;
            vertical-align: top;
        }

        /* Product Table */
        .product-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #000;
        }

        .product-table th,
        .product-table td {
            border: 1px solid #000;
            padding: 6px 4px;
            text-align: center;
            font-size: 13px;
            vertical-align: middle;
        }

        .product-table th {
            background-color: #ffe599;
            font-weight: bold;
            border: 1px solid #000;
            padding: 6px 4px;
            text-align: center;
            font-size: 13px;
            vertical-align: middle;
        }

        /* Style cho header t·∫ßng 2 */
        .product-table thead tr:nth-child(2) th {
            font-size: 11px;
        }

        /* ·∫®n border-top cho h√†ng th·ª© 2 c·ªßa header */
        .product-table thead tr:nth-child(2) th[style*="border-top: none"] {
            border-top: none;
            background-color: transparent;
        }

        .product-name {
            text-align: left !important;
            width: auto !important;
            padding-left: 6px !important;
            font-weight: bold;
        }

        .stt-col {
            width: 9mm;
        }

        .so-kien-col {
            width: 12mm;
        }

        .quantity-col {
            width: 19.4mm;
        }

        .quantity-col-2 {
            width: 15mm;
        }

        .xac-nhan-col {
            width: 16mm;
        }

        .ghi-chu-col {
            width: 27mm;
        }

        /* Notes */
        .notes {
            font-size: 14px;
            font-style: italic;
            line-height: 1.3;
            font-weight: bold;
            color: #081b3a;
        }

        /* Signature Section */
        .signature-section {
            display: flex;
        }

        .signature-box {
            flex: 1;
            border: 1px solid #000;
            text-align: center;
            height: 140px;
            padding-bottom: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .signature-box:not(:last-child) {
            border-right: none;
        }

        .signature-title {
            font-weight: bold;
            padding: 10px;
            font-size: 15px;
            border-bottom: 1px solid #000;
        }

        .signature-name {
            font-weight: bold;
            font-size: 13px;
            margin-top: auto;
        }

        /* Loading & Error */
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }

        .error {
            color: red;
            text-align: center;
            padding: 20px;
        }

        .warning {
            color: orange;
            text-align: center;
            padding: 20px;
            font-style: italic;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        /* Print Status */
        .print-status {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 5px;
            z-index: 10000;
            display: none;
        }

        /* Delivery Notes */
        .delivery-notes {
            font-size: 14px;
            font-weight: bold;
            line-height: 1.3;
            border: 1px solid #000;
            border-top: none;
            padding: 4px 6px;
        }

        /* Print Styles */
        @media print {

            @page {
                size: A4;
                margin: 8mm !important;
                /* gi·∫£m margin */
            }

            html {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }

            body {
                padding: 0;
                margin: 0;
                font-size: 13px;
                background: white !important;
            }

            .container {
                max-width: none;
                width: 100%;
                margin: 0;
                padding: 0;
            }

            .print-controls {
                display: none !important;
            }

            .loading-overlay {
                display: none !important;
            }

            .customer-info,
            .product-table {
                border-collapse: collapse;
                page-break-inside: avoid;
            }

            .product-table {
                page-break-inside: auto;
            }

            .product-table tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            .signature-section {
                page-break-inside: avoid;
            }

            .title {
                font-size: 24px;
            }

            .product-table th,
            .product-table td {
                padding: 6px 4px !important;
                font-size: 13px !important;
            }

            .customer-info td {
                padding: 6px !important;
                font-size: 15px !important;
            }

            .delivery-notes {
                page-break-inside: avoid;
            }
        }
    </style>
</head>

<body>
    <!-- Print Controls -->
    <div class="print-controls">
        <button class="print-btn" onclick="printDocument()" id="printBtn">
            üñ®Ô∏è In phi·∫øu giao h√†ng
        </button>
    </div>

    <!-- Print Status -->
    <div class="print-status" id="printStatus">
        ƒêang chu·∫©n b·ªã in...
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div style="text-align: center;">
            <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <img src="https://poalninh.github.io/PostPrint/logo moc an-01.png" alt="Logo M·ªôc ·∫§n">
            </div>
        </div>

        <!-- Title and Order Number -->
        <div class="title">PHI·∫æU GIAO H√ÄNG</div>
        <div class="order-number">
            <div style="margin-bottom: 10px;">Ng√†y <span id="ngayGiao">11 th√°ng 06 nƒÉm 2025</span></div>

            <div style="font-weight: bold;">S·ªë: <span id="soPhieuGH">GH230610014006</span></div>

        </div>

        <!-- Customer Info -->
        <table class="customer-info">
            <tr>
                <td width="60%">Kh√°ch h√†ng: <strong id="tenKhachHang"></strong></td>

                <td>S·ªë ƒëi·ªán tho·∫°i: <strong id="soDienThoai"></strong></td>
            </tr>
            <tr>
                <td colspan="2">ƒê·ªãa ch·ªâ giao h√†ng: <strong id="diaChiGiaoHang"></strong></td>
            </tr>
            <tr>
                <td>Ng∆∞·ªùi li√™n h·ªá: <strong id="nguoiLienHe"></strong></td>
                <td>H√¨nh th·ª©c v·∫≠n chuy·ªÉn: <strong id="hinhThucVanChuyen"></strong></td>
            </tr>
        </table>

        <!-- Product Table -->
        <table class="product-table">
            <thead>
                <tr>
                    <th rowspan="2" class="stt-col">STT</th>
                    <th rowspan="2" style="text-align: center;">N·ªòI DUNG</th>
                    <th rowspan="2" class="so-kien-col">ƒêVT</th>
                    <th colspan="3" style="text-align: center; background-color: #ffe599; font-weight: bold;">S·ªê L∆Ø·ª¢NG
                    </th>
                    <th rowspan="2" class="xac-nhan-col">X√ÅC NH·∫¨N</th>
                    <th rowspan="2" class="ghi-chu-col">GHI CH√ö</th>
                </tr>
                <tr>
                    <th class="quantity-col">Th·ª±c giao</th>
                    <th class="quantity-col-2">B√π hao</th>
                    <th class="quantity-col">Th·ª±c t√≠nh</th>
                </tr>
            </thead>
            <tbody id="productTableBody">
            </tbody>
        </table>
        <!-- Ghi ch√∫ t·ª´ phi·∫øu giao h√†ng -->
        <div class="delivery-notes" id="deliveryNotes">
            Ghi ch√∫: <span id="ghiChuGiaoHang"></span>
        </div>

        <!-- Notes -->
        <div class="notes">
            Qu√Ω kh√°ch vui l√≤ng ki·ªÉm tra k·ªπ h√†ng tr∆∞·ªõc khi k√Ω nh·∫≠n. N·∫øu c√≥ th·∫Øc m·∫Øc, xin vui l√≤ng li√™n h·ªá v·ªõi ch√∫ng t√¥i
            trong v√≤ng 7 ng√†y k·ªÉ t·ª´ ng√†y nh·∫≠n h√†ng. Sau th·ªùi gian n√†y, ch√∫ng t√¥i xin ph√©p kh√¥ng gi·∫£i quy·∫øt c√°c v·∫•n ƒë·ªÅ
            li√™n quan ƒë·∫øn s·ªë l∆∞·ª£ng.
        </div>

        <!-- Signature Section -->
        <div class="signature-section">
            <div class="signature-box">
                <div class="signature-title">Ng∆∞·ªùi nh·∫≠n h√†ng</div>
                <div class="signature-name" id="nguoiNhanHangKy"></div>
            </div>
            <div class="signature-box">
                <div class="signature-title">Ng∆∞·ªùi giao h√†ng</div>
                <div class="signature-name" id="taiXe"></div>
            </div>
            <div class="signature-box">
                <div class="signature-title">Ng∆∞·ªùi l·∫≠p</div>
                <div class="signature-name" id="nguoiTao"></div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_CONFIG = {
            APP_ID: '323b6578-b51a-425a-9775-c84d2d8d0904',
            ACCESS_KEY: 'V2-MipF3-d6wQk-t6AIN-zzz0j-HglL4-Uq2Yp-EckHF-m3lOV',
            REGION: 'www',
            BASE_URL: 'https://www.appsheet.com/api/v2/apps',
            APP_NAME: 'MocAnSystem-777046908'
        };

        // Set document title for printing
        function setDocumentTitle(soPhieu) {
            if (soPhieu && soPhieu !== 'ƒêang t·∫£i...') {
                document.title = soPhieu;
            }
        }

        // State Management
        let state = {
            deliveryData: null,
            loading: false
        };

        // Print Functions
        const PrintManager = {
            print: async () => {
                try {
                    if (!state.deliveryData) {
                        alert('Vui l√≤ng ƒë·ª£i d·ªØ li·ªáu t·∫£i xong tr∆∞·ªõc khi in!');
                        return;
                    }

                    const printBtn = document.getElementById('printBtn');
                    const originalText = printBtn.innerHTML;
                    printBtn.disabled = true;
                    printBtn.innerHTML = '‚è≥ ƒêang in...';

                    PrintManager.showPrintStatus('ƒêang chu·∫©n b·ªã in...');

                    const soPhieu = document.getElementById('soPhieuGH').textContent;
                    if (soPhieu && soPhieu !== 'ƒêang t·∫£i...') {
                        document.title = `PhieuGiaoHang_${soPhieu}`;
                    }

                    PrintManager.hidePrintStatus();
                    window.print();

                    setTimeout(() => {
                        printBtn.disabled = false;
                        printBtn.innerHTML = originalText;
                    }, 1000);

                } catch (error) {
                    console.error('Print error:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi in. Vui l√≤ng th·ª≠ l·∫°i!');

                    const printBtn = document.getElementById('printBtn');
                    printBtn.disabled = false;
                    printBtn.innerHTML = 'üñ®Ô∏è In phi·∫øu giao h√†ng';

                    PrintManager.hidePrintStatus();
                }
            },

            showPrintStatus: (message) => {
                const status = document.getElementById('printStatus');
                status.textContent = message;
                status.style.display = 'block';
            },

            hidePrintStatus: () => {
                const status = document.getElementById('printStatus');
                status.style.display = 'none';
            }
        };

        // Global print function
        function printDocument() {
            PrintManager.print();
        }

        // API Service
        const apiService = {
            createAxiosInstance() {
                return axios.create({
                    baseURL: `${API_CONFIG.BASE_URL}/${API_CONFIG.APP_ID}/tables`,
                    headers: {
                        'ApplicationAccessKey': API_CONFIG.ACCESS_KEY,
                        'Content-Type': 'application/json'
                    }
                });
            },

            async request(tableName, action, data = {}, select = {}) {
                try {
                    const api = this.createAxiosInstance();
                    const requestBody = {
                        Action: action,
                        Properties: {
                            UserSettings: {
                                "User name": "Admin",
                                "Password": "123456"
                            },
                            ...select
                        },
                        ...data
                    };

                    const response = await api.post(`/${tableName}/Action`, requestBody);
                    return response.data;
                } catch (error) {
                    console.error('API request failed:', error);
                    throw error;
                }
            }
        };

        // Loading Management
        const showLoading = () => {
            document.getElementById('loadingOverlay').style.display = 'flex';
            state.loading = true;
        };

        const hideLoading = () => {
            document.getElementById('loadingOverlay').style.display = 'none';
            state.loading = false;
        };

        // Utility Functions
        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return new Intl.NumberFormat('vi-VN').format(num);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;

                const day = date.getDate();
                const month = date.getMonth() + 1;
                const year = date.getFullYear();

                return `${day} th√°ng ${month} nƒÉm ${year}`;
            } catch (error) {
                return dateString;
            }
        }

        // Fetch Delivery Data
        async function fetchDeliveryData(deliveryId) {
            try {
                showLoading();

                const [header, details, nhanVienData] = await Promise.all([
                    apiService.request('GiaoHang', 'Find', {}, {
                        Selector: `Filter(GiaoHang, [S·ªë phi·∫øu GH] = '${deliveryId}')`
                    }),
                    apiService.request('CTGiaoHang', 'Find', {}, {
                        Selector: `Filter(CTGiaoHang, [S·ªë phi·∫øu GH] = '${deliveryId}')`
                    }),
                    // L·∫•y t·∫•t c·∫£ nh√¢n vi√™n ƒë·ªÉ lookup
                    apiService.request('NhanVien', 'Find', {}, {})
                ]);

                if (!header || header.length === 0) {
                    throw new Error(`Kh√¥ng t√¨m th·∫•y phi·∫øu giao h√†ng v·ªõi s·ªë: ${deliveryId}`);
                }

                state.deliveryData = {
                    header: header[0],
                    details: details || [],
                    nhanVien: nhanVienData || []
                };

                return state.deliveryData;
            } catch (error) {
                console.error('Error fetching delivery:', error);
                throw error;
            } finally {
                hideLoading();
            }
        }

        // Helper function ƒë·ªÉ t√¨m t√™n nh√¢n vi√™n theo m√£
        function getTenNhanVien(maNV, danhSachNhanVien) {
            if (!maNV || !danhSachNhanVien) return maNV || '';

            const nhanVien = danhSachNhanVien.find(nv => nv['M√£ NV'] === maNV);
            return nhanVien ? nhanVien['H·ªç v√† t√™n'] : maNV;
        }

        // Populate Delivery Header
        function populateDeliveryHeader(giaoHang, danhSachNhanVien = []) {
            try {
                const soPhieu = giaoHang['S·ªë phi·∫øu GH'] || ' ';
                document.getElementById('soPhieuGH').textContent = soPhieu;
                document.getElementById('ngayGiao').textContent = formatDate(giaoHang['Ng√†y giao']);

                setDocumentTitle(soPhieu);

                document.getElementById('tenKhachHang').textContent = giaoHang['T√™n kh√°ch h√†ng'] || ' ';
                document.getElementById('soDienThoai').textContent = giaoHang['S·ªë ƒëi·ªán tho·∫°i'] || ' ';
                document.getElementById('diaChiGiaoHang').textContent = giaoHang['ƒê·ªãa ch·ªâ giao h√†ng'] || ' ';
                document.getElementById('nguoiLienHe').textContent = giaoHang['Ng∆∞·ªùi nh·∫≠n h√†ng'] || ' ';
                document.getElementById('hinhThucVanChuyen').textContent = giaoHang['H√¨nh th·ª©c giao'] || ' ';

                // Th√™m ghi ch√∫ t·ª´ b·∫£ng GiaoHang
                const ghiChu = giaoHang['Ghi ch√∫'] || '';
                document.getElementById('ghiChuGiaoHang').textContent = ghiChu;

                // Th√™m th√¥ng tin k√Ω t√™n t·ª´ b·∫£ng GiaoHang - lookup t√™n th·∫≠t t·ª´ m√£ NV
                document.getElementById('nguoiNhanHangKy').textContent = giaoHang['Ng∆∞·ªùi nh·∫≠n h√†ng'] || '';
                document.getElementById('taiXe').textContent = getTenNhanVien(giaoHang['T√†i x·∫ø'], danhSachNhanVien);
                document.getElementById('nguoiTao').textContent = getTenNhanVien(giaoHang['Ng∆∞·ªùi t·∫°o'], danhSachNhanVien);

            } catch (error) {
                console.error('Error populating header:', error);
                throw error;
            }
        }

        // Populate Product Table
        async function populateProductTable(chiTietGiaoHang) {
            const tbody = document.getElementById('productTableBody');
            tbody.innerHTML = '';

            try {
                if (chiTietGiaoHang.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="warning">‚ö†Ô∏è Kh√¥ng c√≥ chi ti·∫øt s·∫£n ph·∫©m cho phi·∫øu giao h√†ng n√†y</td></tr>';
                    return;
                }

                for (let index = 0; index < chiTietGiaoHang.length; index++) {
                    const item = chiTietGiaoHang[index];

                    const dvt = item['ƒêvt'] || '';
                    const thucGiao = parseFloat(item['SL th·ª±c giao']) || 0;
                    const buHao = parseFloat(item['SL b√π hao']) || 0;
                    const thucTinh = parseFloat(item['SL th·ª±c t√≠nh']) || 0;

                    const row = document.createElement('tr');

                    const tenSanPham = item['T√™n S·∫£n ph·∫©m'] || '';
                    const soDH = item['S·ªë ƒêH'] || '';
                    const noiDung = tenSanPham + (soDH ? `<br>S·ªê ƒêH: <span style="font-weight: normal;">${soDH}</span>` : '');

                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td class="product-name">${noiDung}</td>
                        <td>${dvt}</td>
                        <td class="number">${formatNumber(thucGiao)}</td>
                        <td class="number">${formatNumber(buHao)}</td>
                        <td class="number">${formatNumber(thucTinh)}</td>
                        <td></td>
                        <td>${item['Ghi ch√∫'] || ''}</td>
                    `;
                    tbody.appendChild(row);
                }

            } catch (error) {
                console.error('Error in populateProductTable:', error);
                throw error;
            }
        }

        // Show Error
        function showError(message) {
            const tbody = document.getElementById('productTableBody');
            tbody.innerHTML = `<tr><td colspan="10" class="error">‚ùå L·ªói: ${message}</td></tr>`;

            const fields = ['soPhieuGH', 'ngayGiao', 'tenKhachHang', 'soDienThoai', 'diaChiGiaoHang', 'nguoiLienHe', 'hinhThucVanChuyen'];
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) element.textContent = 'L·ªói t·∫£i d·ªØ li·ªáu';
            });
        }

        // Get URL Parameter
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                printDocument();
            }
        });

        // Initialize - Document Ready
        document.addEventListener('DOMContentLoaded', function () {
            initializeDeliveryData();
        });

        // Initialize Delivery Data
        async function initializeDeliveryData() {
            try {
                const deliveryId = getUrlParameter('deliveryId');

                if (!deliveryId) {
                    throw new Error('Vui l√≤ng cung c·∫•p deliveryId trong URL (v√≠ d·ª•: ?deliveryId=GH001)');
                }

                const deliveryData = await fetchDeliveryData(deliveryId);
                populateDeliveryHeader(deliveryData.header, deliveryData.nhanVien);
                await populateProductTable(deliveryData.details);

                // Enable print control after data is loaded
                document.getElementById('printBtn').disabled = false;

            } catch (error) {
                console.error('Error initializing delivery data:', error);
                showError(error.message);

                // Disable print control if data loading fails
                document.getElementById('printBtn').disabled = true;
            }
        }

        // Export functions for external use
        window.PrintManager = PrintManager;
        window.printDocument = printDocument;

        // Disable right-click and keyboard shortcuts for security
        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        }, false);

        document.onkeydown = function (e) {
            if (e.keyCode == 123) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
                return false;
            }
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
                return false;
            }
        };
    </script>
</body>

</html>