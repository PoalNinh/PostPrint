<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8">
    <title>H√≥a ƒë∆°n b√°n h√†ng</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

    <style>
        /* Gi·ªØ nguy√™n ph·∫ßn CSS c·ªßa b·∫°n */
        td,
        th {
            padding: 5px 6px;
        }

        p,
        h3,
        h4,
        a {
            text-align: center;
        }

        h5,
        h4,
        h6,
        p {
            margin: 3px 0 0 0;
        }

        .invoiceContainer {
            position: relative;
        }

        .qrCode {
            position: right;
            top: 1px;
            right: 1px;
        }

        p {
            line-height: 1;
            text-align: left;
            font-size: 10px;
        }

        tfoot {
            text-align: center;
            text-transform: uppercase;
            font: bold 60% sans-serif;
        }

        h1 {
            font: bold 60% sans-serif;
            text-align: center;
            line-height: 0.3;
        }

        dc {
            font: bold 60% sans-serif;
            text-align: center;
            word-wrap: break-word;
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 6px;
            box-sizing: border-box;
            line-height: 1.2;
        }

        h3 {
            font: bold 100% sans-serif;
            text-align: center;
            line-height: 0.1;
            font-size: 20px;
        }

        h4 {
            font: bold 15px sans-serif;
            text-align: center;
            text-transform: uppercase;
            line-height: 0.8;
        }

        h5,
        h6 {
            font: bold 50% sans-serif;
            text-align: center;
            text-transform: uppercase;
            line-height: 1.2;
        }

        table,
        td,
        th {
            border-bottom: 1px solid #333;
            border-collapse: collapse;
            font-size: 10px;
            line-height: 1;
        }

        body {
            font-size: 16px;
            font-family: Arial, Helvetica, sans-serif;
            line-height: 1.3;
            box-sizing: border-box;
            height: 297mm;
            margin: 0 auto;
            overflow: hidden;
            padding: 3mm;
            width: 80mm;
            background: #FFF;
            border-radius: 1px;
            box-shadow: 0 0 1in -0.25in rgba(0, 0, 0, 0.5);
        }

        img {
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        #table1 {
            margin: 0 auto;
        }

        #setup-print {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 200px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        #setup-print select,
        #setup-print input,
        #setup-print button {
            width: 100%;
            margin-bottom: 10px;
        }

        #custom-size-inputs {
            display: none;
        }

        @media print {
            #printButton {
                display: none;
            }

            #setup-print {
                display: none;
            }
        }

        .leftIndent,
        .amount {
            padding-left: 30px;
            display: flex;
            align-items: center;
            height: 100%;
        }

        .leftIndent,
        .note {
            padding-left: 30px;
            display: flex;
            align-items: center;
            height: 100%;
        }

        .note {
            padding-left: 30px;
            display: flex;
            align-items: center;
            height: 100%;
            font-weight: bold;
        }

        .totalRow,
        .shippingCostRow,
        .discountRow,
        .amountDueRow,
        .noteDueRow {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10px;
            padding: 5px 6px;
            width: 90%;
            box-sizing: border-box;
            line-height: 0.3;
        }

        p {
            line-height: 0.3;
        }

        .paymentText {
            text-align: center;
            margin-bottom: 10px;
        }

        .paymentQR {
            display: block;
            margin: 0 auto;
            margin-top: 10px;
        }

        .inline {
            display: inline;
        }

        .center {
            text-align: center;
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        /* Media query cho kh·ªï gi·∫•y */
        [data-paper-size='A4'] {
            width: 210mm;
        }

        [data-paper-size='A5'] {
            width: 148mm;
        }

        [data-paper-size='A6'] {
            width: 105mm;
        }

        [data-paper-size='A7'] {
            width: 74mm;
        }

        [data-paper-size='thermal-80'] {
            width: 80mm;
        }

        [data-paper-size='thermal-58'] {
            width: 58mm;
        }

        /* K√≠ch th∆∞·ªõc t√πy ch·ªânh */
        [data-paper-size='custom'] {
            width: var(--custom-width, 210mm);
        }

        /* Chi·ªÅu cao t·ªëi thi·ªÉu cho n·ªôi dung */
        #content {
            min-height: auto;
            height: auto;
            /* Chi·ªÅu cao d·ª±a tr√™n n·ªôi dung */
        }
    </style>
</head>

<body>
    <div id="loading-screen">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">ƒêang t·∫£i...</span>
        </div>
    </div>
    <div id="setup-print">
        <select id="select-paper-size" class="form-control mb-2">
            <option value="A4">A4</option>
            <option value="A5">A5</option>
            <option value="A6">A6</option>
            <option value="A7">A7</option>
            <option value="thermal-80" selected>M√°y in nhi·ªát 80mm</option>
            <option value="thermal-58">M√°y in nhi·ªát 58mm</option>
            <option value="custom">K√≠ch th∆∞·ªõc t√πy ch·ªânh</option>
        </select>
        <div id="custom-size-inputs" class="mb-2">
            <input type="number" id="custom-width" placeholder="Chi·ªÅu r·ªông (mm)" class="form-control mb-2">
            <input type="number" id="custom-height" placeholder="Chi·ªÅu cao (mm)" class="form-control">
        </div>
        <select id="select-paper-orientation" class="form-control mb-2">
            <option value="portrait">D·ªçc</option>
            <option value="landscape">Ngang</option>
        </select>
        <select id="paymentMethod" class="form-control mb-2" onchange="updatePaymentMethod()">
            <option value="cash">Ti·ªÅn m·∫∑t</option>
            <option value="transfer" selected>Chuy·ªÉn kho·∫£n</option>
        </select>
        <select id="accountSelect" class="form-control mb-2" style="display: none;" onchange="updateAccountInfo()">
            <option value="vcb">VPB: 113809086 - Ch·ªß TK: LE BICH NGOC</option>
        </select>
        <label for="printerIp">IP m√°y in:</label>
        <input type="text" id="printerIp" placeholder="V√≠ d·ª•: 192.168.1.100" class="form-control mb-2">
        <label for="printerPort">C·ªïng m√°y in:</label>
        <input type="number" id="printerPort" placeholder="V√≠ d·ª•: 9100" class="form-control mb-2">
        <button onclick="printDocument()" class="btn btn-info mb-2">
            <i class="fa fa-print"></i> In
        </button>
        <button onclick="exportToPDF()" class="btn btn-primary">
            <i class="fa fa-file-pdf"></i> Xu·∫•t PDF
        </button>
    </div>
    <div id="content">
        <h3>shop nh√† ng·ªë</h3>
        <h1>ƒê·ªãa ch·ªâ: 21 Linh ƒê∆∞·ªùng - Linh ƒê√†m - H√† N·ªôi</h1>
        <h1>SƒêT: 0986.857.087</h1>
        <h1>üè¶ VP BANK: 113809086 L√™ B√≠ch Ng·ªçc</h1>
        <h1>................................................</h1>
        <h3>H√ìA ƒê∆†N B√ÅN H√ÄNG</h3>
        <h1>Kh√°ch h√†ng: <span id="tenkh"></span></h1>
        <div class="center">
            <h1 class="inline">SƒêT: </h1>
            <h4 class="inline" id="sodtkh"></h4>
        </div>
        <div class="center">
            <p class="dc" id="chinhanh"></p>
        </div>
        <div class="invoiceContainer">
            <table id="table1">
                <thead>
                    <tr>
                        <th>T√äN SP</th>
                        <th>SL</th>
                        <th>ƒê∆†N GI√Å</th>
                        <th>T·ªîNG TI·ªÄN</th>
                    </tr>
                </thead>
                <tbody id="orderDetailsBody"></tbody>
            </table>
            <div class="totalRow">
                <p class="leftIndent"><strong>T·ªïng ti·ªÅn:</strong></p>
                <p class="amount"><span id="tongGiaTri"></span></p>
            </div>
            <div class="shippingCostRow">
                <p class="leftIndent"><strong>Ph√≠ ship:</strong></p>
                <p class="amount"><span id="phiShip"></span></p>
            </div>
            <div class="discountRow">
                <p class="leftIndent"><strong>Gi·∫£m gi√°:</strong></p>
                <p class="amount"><span id="giamGia"></span></p>
            </div>
            <div class="amountDueRow">
                <p class="leftIndent"><strong>ƒê√£ thanh to√°n:</strong></p>
                <p class="amount"><span id="khachdatra"></span></p>
            </div>
            <div class="amountDueRow">
                <p class="leftIndent"><strong>C√≤n ph·∫£i thanh to√°n:</strong></p>
                <p class="amount"><span id="conlai"></span></p>
            </div>
            <div class="noteDueRow">
                <p class="leftIndent"><strong>Ghi ch√∫:</strong></p>
                <p class="note"><span id="ghiChu"></span></p>
            </div>
            <p class="paymentText">Thanh to√°n QR Code</p>
            <img id="qrCodeImage" src="" alt="QR Code" width="100" height="100" class="paymentQR">
            <h1>C·∫£m ∆°n Qu√Ω kh√°ch, h·∫πn g·∫∑p l·∫°i!</h1>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwLSIJXzRVaOzEsFqWtgwDWQpjRKyrp8CM6gfEem6qmzmqkti6HLp-EgwZkiotUX9LP/exec';

        // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu
        var BAN_GIAO = {};
        var CT_BANGIAO = [];

        // H√†m ƒë·ªÉ hi·ªÉn th·ªã m√†n h√¨nh loading
        function showLoading() {
            document.getElementById('loading-screen').style.display = 'flex';
        }

        // H√†m ƒë·ªÉ ·∫©n m√†n h√¨nh loading
        function hideLoading() {
            document.getElementById('loading-screen').style.display = 'none';
        }

        function searchContract(SOBH) {
            showLoading(); // Hi·ªÉn th·ªã m√†n h√¨nh loading tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu t·∫£i

            fetch(`${API_URL}?SOBH=${encodeURIComponent(SOBH)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        BAN_GIAO = data.ctuResult || {};
                        CT_BANGIAO = data.tsDetailResult || [];

                        updateUI();
                    } else {
                        console.error('L·ªói:', data.message);
                    }
                })
                .catch(error => {
                    console.error('ƒê√£ x·∫£y ra l·ªói:', error.message);
                })
                .finally(() => {
                    hideLoading(); // ·∫®n m√†n h√¨nh loading sau khi t·∫£i xong ho·∫∑c x·∫£y ra l·ªói
                });
        }

        function updateUI() {
            document.getElementById('sodtkh').textContent = BAN_GIAO['SƒêT'] || '';
            document.getElementById('tenkh').textContent = BAN_GIAO['Kh√°ch h√†ng'] || '';
            document.getElementById('chinhanh').textContent = BAN_GIAO['ƒê·ªãa ch·ªâ'] || '';
            document.getElementById('tongGiaTri').textContent = formatCurrency(BAN_GIAO['T·ªïng ti·ªÅn'] || '0');
            document.getElementById('giamGia').textContent = formatCurrency(BAN_GIAO['Gi·∫£m gi√° h√≥a ƒë∆°n'] || '0');
            document.getElementById('khachdatra').textContent = formatCurrency(BAN_GIAO['ƒê√£ thanh to√°n'] || '0');
            document.getElementById('conlai').textContent = formatCurrency(BAN_GIAO['C√≤n ph·∫£i thanh to√°n'] || '0');
            document.getElementById('phiShip').textContent = formatCurrency(BAN_GIAO['Ph√≠ ship'] || '0');
            document.getElementById('ghiChu').textContent = BAN_GIAO['Ghi ch√∫'] || '';

            updateProductTable();
            updateQRCode();
        }

        function updateProductTable() {
            const tableBody = document.getElementById('orderDetailsBody');
            tableBody.innerHTML = '';

            if (Array.isArray(CT_BANGIAO) && CT_BANGIAO.length > 0) {
                CT_BANGIAO.forEach((item, index) => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${item['T√™n s·∫£n ph·∫©m'] || ''}</td>
                        <td style="text-align: center;">${item['S·ªë l∆∞·ª£ng'] || ''}</td>
                        <td style="text-align: center;">${formatCurrency(item['ƒê∆°n gi√°'] || '')}</td>
                        <td style="text-align: right;">${formatCurrency(item['Th√†nh ti·ªÅn'])}</td>
                    `;
                });
            } else {
                tableBody.innerHTML = '<tr><td colspan="4">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
            }
        }

        function updateQRCode() {
            const amount = BAN_GIAO['C√≤n ph·∫£i thanh to√°n'] || 0;
            const qrCodeUrl = `https://img.vietqr.io/image/VPbank-113809086-compact.png?amount=${amount}&addInfo=Thanh toan don hang&accountName=LE BIC NGOC`;
            document.getElementById('qrCodeImage').src = qrCodeUrl;
        }

        function formatCurrency(value) {
            if (!value) return '0';
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
        }

        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const SOBH = urlParams.get('SOBH');
            if (SOBH) {
                searchContract(SOBH);
            } else {
                console.error('Vui l√≤ng cung c·∫•p s·ªë h·ª£p ƒë·ªìng trong URL (v√≠ d·ª•: ?SOBH=HD001)');
                hideLoading(); // ·∫®n m√†n h√¨nh loading n·∫øu kh√¥ng c√≥ SOBH
            }
        });
        // Th√™m c√°c h√†m m·ªõi
        function updatePaymentMethod() {
            const paymentMethod = document.getElementById('paymentMethod').value;
            const accountSelect = document.getElementById('accountSelect');
            const qrCodeContainer = document.getElementById('qrCodeContainer');

            if (paymentMethod === 'transfer') {
                accountSelect.style.display = 'block';
                updateAccountInfo();
            } else {
                accountSelect.style.display = 'none';
                if (qrCodeContainer) qrCodeContainer.style.display = 'none';
            }
        }

        function updateAccountInfo() {
            const accountSelect = document.getElementById('accountSelect');
            const selectedAccount = accountSelect.options[accountSelect.selectedIndex];
            const accountInfo = document.getElementById('accountInfo');
            if (accountInfo) accountInfo.textContent = selectedAccount.text;

            updateQRCode();
        }

        function updateQRCode() {
            const amount = BAN_GIAO['C√≤n ph·∫£i thanh to√°n'] || 0;
            const accountSelect = document.getElementById('accountSelect');
            const selectedAccount = accountSelect.value;
            let bankId, accountNo, accountName;

            if (selectedAccount === 'vcb') {
                bankId = '970432';
                accountNo = '113809086';
                accountName = 'LE BICH NGOC';
            }

            const qrUrl = `https://img.vietqr.io/image/${bankId}-${accountNo}-compact.png?amount=${amount}&addInfo=Thanh toan don hang&accountName=${encodeURIComponent(accountName)}`;
            const qrCodeImage = document.getElementById('qrCodeImage');
            if (qrCodeImage) qrCodeImage.src = qrUrl;
        }
        // H√†m c·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc gi·∫•y v√† ƒëi·ªÅu ch·ªânh n·ªôi dung
        function updatePageFormat() {
            const size = document.getElementById('select-paper-size').value;
            const orientation = document.getElementById('select-paper-orientation').value;

            document.body.setAttribute('data-paper-size', size);
            document.body.setAttribute('data-paper-orientation', orientation);

            adjustContentSize(size, orientation);
            adjustFontSize(size);
        }

        // ƒêi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc n·ªôi dung d·ª±a tr√™n kh·ªï gi·∫•y
        function adjustContentSize(size, orientation) {
            let width, height;

            switch (size) {
                case 'A4':
                    width = '210mm';
                    height = '297mm';
                    break;
                case 'A5':
                    width = '148mm';
                    height = '210mm';
                    break;
                case 'A6':
                    width = '105mm';
                    height = '148mm';
                    break;
                case 'A7':
                    width = '74mm';
                    height = '105mm';
                    break;
                case 'thermal-80':
                    width = '80mm';
                    height = 'auto';
                    break;
                case 'thermal-58':
                    width = '58mm';
                    height = 'auto';
                    break;
                case 'custom':
                    width = document.getElementById('custom-width').value + 'mm';
                    height = document.getElementById('custom-height').value + 'mm';
                    break;
                default:
                    width = '210mm';
                    height = '297mm';
            }

            if (orientation === 'landscape') {
                [width, height] = [height, width];
            }

            const content = document.getElementById('content');
            content.style.width = width;
            // Kh√¥ng ƒë·∫∑t chi·ªÅu cao c·ªë ƒë·ªãnh, ƒë·ªÉ chi·ªÅu cao t·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh theo n·ªôi dung
            content.style.minHeight = height;
        }

        function adjustFontSize(size) {
            const content = document.getElementById('content');
            let fontSize;

            switch (size) {
                case 'A4':
                    fontSize = '12px';
                    break;
                case 'A5':
                    fontSize = '10px';
                    break;
                case 'A6':
                case 'A7':
                    fontSize = '8px';
                    break;
                case 'thermal-80':
                case 'thermal-58':
                    fontSize = '8px';
                    break;
                default:
                    fontSize = '12px';
            }

            content.style.fontSize = fontSize;
        }

        function printDocument() {
            updatePageFormat();
            const printerIp = document.getElementById('printerIp').value.trim();
            const printerPort = document.getElementById('printerPort').value.trim();

            if (printerIp && printerPort) {
                const contentToPrint = document.getElementById('content').innerHTML;
                    
                    const printData = {
                        content: contentToPrint,
                        paperSize,
                        orientation
                    };

                    const response =  fetch(`http://${printerIp}:${printerPort}/api/print`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(printData),
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data =  response.json();

                alert(`G·ª≠i l·ªánh in ƒë·∫øn m√°y in t·∫°i ${printerIp}:${printerPort}`);
            } else {
                window.print();
            }
        }

        function exportToPDF() {
            updatePageFormat();
            const element = document.getElementById('content');
            const opt = {
                margin: 10,
                filename: 'hoa-don.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().from(element).set(opt).save();
        }

        // Th√™m c√°c s·ª± ki·ªán c·∫ßn thi·∫øt khi t√†i li·ªáu ƒë∆∞·ª£c t·∫£i xong
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const SOBH = urlParams.get('SOBH');
            if (SOBH) {
                searchContract(SOBH);
            } else {
                console.error('Vui l√≤ng cung c·∫•p s·ªë h·ª£p ƒë·ªìng trong URL (v√≠ d·ª•: ?SOBH=HD001)');
                hideLoading();
            }

            document.getElementById('select-paper-size').addEventListener('change', function () {
                document.getElementById('custom-size-inputs').style.display = this.value === 'custom' ? 'block' : 'none';
                updatePageFormat();
            });

            document.getElementById('select-paper-orientation').addEventListener('change', updatePageFormat);
            document.getElementById('custom-width').addEventListener('input', updatePageFormat);
            document.getElementById('custom-height').addEventListener('input', updatePageFormat);
            document.getElementById('paymentMethod').addEventListener('change', updatePaymentMethod);
            document.getElementById('accountSelect').addEventListener('change', updateAccountInfo);

            updatePageFormat();
            updatePaymentMethod();
        });
    </script>
</body>

</html>
